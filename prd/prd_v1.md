---

# **PRD文档：音乐社区平台**

## **1. 文档概述**
### **1.1 产品目标**
构建一个以音乐交流为核心的社区平台，支持用户发布主题、互动讨论、打赏激励，并通过VIP特权与金币体系增强用户粘性。

---

## **2. 产品范围**
### **2.1 核心功能模块**
| 模块                | 功能描述                                                                 |
|---------------------|--------------------------------------------------------------------------|
| 用户注册与登录      | 多方式注册登录（用户名+密码、手机/邮箱+验证码）                          |
| 用户信息管理        | 基础信息展示、金币/积分/成长值统计、VIP状态                              |
| 充值系统            | 金币充值（支付宝/微信支付，阶梯比例）                                    |
| VIP特权系统         | 金币购买VIP（1年起步，特权：免回复查看隐藏内容、回复不扣金币）           |
| 主题发布与互动      | 富文本编辑、隐藏内容设置、回复/点赞/收藏/打赏                            |
| 内容展示与权限控制  | 游客与登录用户差异化展示，VIP特权内容解锁                                |

---

## **3. 功能需求详述**
### **3.1 用户系统**
#### **3.1.1 注册与登录**
- **注册方式**  
  - 用户名+密码：密码需加密存储（SHA-256+盐值）  
  - 手机号/邮箱+验证码：验证码有效期5分钟，单日发送上限5次  
  - 第三方登录：微信、QQ、微博（OAuth 2.0集成）  

- **登录校验**  
  - 错误锁定：连续5次错误密码后锁定账号30分钟  
  - 多设备登录限制：同一账号最多3台设备同时在线  

#### **3.1.2 用户信息**
| 字段            | 类型      | 规则                                                                 |
|-----------------|-----------|----------------------------------------------------------------------|
| 用户ID          | UUID      | 唯一标识                                                            |
| 用户名          | String    | 4-20字符，允许中英文、数字、下划线                                   |
| 头像            | URL       | 默认头像，支持上传（限制格式：PNG/JPG，大小<2MB）                    |
| 金币余额        | Integer   | 初始值0，充值后累加                                                 |
| VIP有效期       | Timestamp | 格式：YYYY-MM-DD HH:MM:SS，到期后自动降级                           |

---

### **3.2 充值与金币模型**
#### **3.2.1 充值规则**
| 充值金额（元） | 金币比例 | 示例（充值100元）         |
|----------------|----------|---------------------------|
| <10            | 1:10     | 9元 → 90金币              |
| ≥10            | 1:11     | 100元 → 1100金币          |

- **支付流程**  
  ```mermaid
  graph TD
    A[用户选择充值金额] --> B{金额≥10元?}
    B -->|是| C[按1:11发放金币]
    B -->|否| D[按1:10发放金币]
    C & D --> E[跳转支付宝/微信支付]
    E --> F[支付成功回调]
    F --> G[更新用户金币余额]
  ```

#### **3.2.2 支付安全**
- **防重复提交**：订单Token有效期15分钟，单订单号仅允许成功回调一次  
- **对账机制**：每日凌晨2点同步支付平台订单状态，修复异常数据  

---

### **3.3 VIP特权系统**
#### **3.3.1 购买规则**
- **定价模型**：1000金币/年，支持倍数购买（如2000金币=2年）  
- **特权生效**：  
  - 购买后立即生效，有效期叠加（如已有1年VIP，再购买1年→总有效期2年）  
  - 特权覆盖范围：  
    - **免回复查看**：直接展示帖子隐藏内容（需前端标记“VIP专属”）  
    - **回复免扣金币**：普通用户每回复扣除1金币，VIP用户不扣除  

---

### **3.4 内容互动模块**
#### **3.4.1 主题发布**
- **富文本编辑器**：  
  - 基础功能：文字加粗/斜体、插入图片/音频链接（支持网易云/B站外链解析）  
  - 隐藏内容标记：用户可勾选“隐藏部分内容”，非VIP用户需回复后查看  

#### **3.4.2 权限控制逻辑**
```python
def check_content_permission(user, post):
    if post.has_hidden_content:
        if user.is_vip_active():
            return "show_full"
        elif user.is_logged_in() and user.has_replied(post.id):
            return "show_full"
        else:
            return "show_preview"
    else:
        return "show_full"
```

---

## **4. 数据模型设计**
### **4.1 核心表结构**
#### **用户表（user）**
| 字段名           | 类型         | 说明                             |
|------------------|--------------|----------------------------------|
| id               | BIGINT       | 主键，自增                       |
| username         | VARCHAR(20)  | 唯一索引                         |
| mobile           | VARCHAR(11)  | 唯一索引，可为空                 |
| email            | VARCHAR(50)  | 唯一索引，可为空                 |
| password_hash    | CHAR(64)     | SHA-256加密                      |
| vip_expire_at    | DATETIME     | 默认NULL，表示非VIP              |

#### **主题表（topic）**
| 字段名           | 类型          | 说明                             |
|------------------|---------------|----------------------------------|
| id               | BIGINT        | 主键，自增                       |
| user_id          | BIGINT        | 外键关联user.id                  |
| hidden_content   | TEXT          | 加密存储（AES-256），前端解密展示|
| like_count       | INT           | 默认0，异步更新                  |

---

## **5. 非功能需求**
### **5.1 性能指标**
- **接口响应**：核心接口（登录/主题加载）平均RT≤300ms  
- **并发能力**：支持5000 QPS，通过Redis缓存热门主题列表  

### **5.2 安全要求**
- **敏感数据加密**：  
  - 密码：SHA-256 + 动态盐值  
  - 手机号/邮箱：数据库字段AES加密  
- **防御措施**：  
  - 注册接口防刷：IP限流10次/分钟  
  - XSS过滤：富文本内容转义处理  

---

## **6. 界面原型（关键页面）**
### **6.1 主题详情页布局**
```plaintext
+-----------------------------+
| 导航栏（登录状态/金币/VIP） |
+-----------------------------+
| 左侧                        |
| - 主题标题                  |
| - 作者信息                  |
| - 正文内容                  |
| - [隐藏内容提示]            |
|                            |
| 右侧                        |
| - 点赞/收藏/打赏按钮        |
| - 回复输入框                |
| - 热门回复列表（分页）      |
+-----------------------------+
```

---

## **7. 版本规划**
| 版本   | 功能范围                     | 里程碑          |
|--------|------------------------------|-----------------|
| V1.0   | 基础注册登录、主题发布/查看  | 2023-12-31上线 |
| V1.5   | 金币充值、VIP特权系统        | 2024-02-28迭代 |
| V2.0   | 音乐播放器集成、打赏排行榜   | 2024-06-30规划 |

---

**附：风险与应对**  
- **支付回调延迟**：设计本地订单状态标记，异步补偿机制  
- **隐藏内容泄露**：服务端渲染时动态控制数据返回，避免前端直接暴露加密内容


