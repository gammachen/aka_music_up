```mermaid
graph TD
    graph TD
    A[用户进入注册/登录页] --> B{选择操作类型}
    B -->|注册| C[选择注册方式]
    B -->|登录| L[选择登录方式]
    
    %% 注册流程
    C --> D1[用户名+密码注册]
    C --> D2[手机号+验证码注册]
    C --> D3[邮箱+验证码注册]
    C --> D4[第三方登录注册]
    
    %% 用户名密码注册
    D1 --> E1[输入用户名]
    E1 --> F1{格式检查}
    F1 -->|不符合规则| G1[提示"用户名需4-20位且不含特殊字符"]
    F1 -->|符合规则| H1[输入密码]
    H1 --> I1{密码强度检查}
    I1 -->|弱密码| J1[提示"密码需包含字母+数字且≥8位"]
    I1 -->|符合要求| K1[提交注册]
    
    %% 手机号注册
    D2 --> E2[输入手机号]
    E2 --> F2{格式检查}
    F2 -->|无效号码| G2[提示"手机号格式错误"]
    F2 -->|有效号码| H2[发送短信验证码]
    H2 --> I2[输入验证码]
    I2 --> J2{校验验证码}
    J2 -->|错误/超时| K2[提示"验证码错误或已过期"]
    J2 -->|正确| L2[设置密码]
    L2 --> M2[提交注册]
    
    %% 邮箱注册
    D3 --> E3[输入邮箱]
    E3 --> F3{格式检查}
    F3 -->|无效邮箱| G3[提示"邮箱格式错误"]
    F3 -->|有效邮箱| H3[发送邮件验证码]
    H3 --> I3[输入验证码]
    I3 --> J3{校验验证码}
    J3 -->|错误/超时| K3[提示"验证码错误或已过期"]
    J3 -->|正确| L3[设置密码]
    L3 --> M3[提交注册]
    
    %% 第三方注册
    D4 --> E4[跳转第三方授权]
    E4 --> F4[获取OpenID/UnionID]
    F4 --> G4{是否已绑定}
    G4 -->|已绑定| H4[自动登录]
    G4 -->|未绑定| I4[引导完善用户名]
    I4 --> J4[提交注册]
    
    %% 公共注册校验
    K1 & M2 & M3 & J4 --> N{检查重复注册}
    N -->|用户名/手机/邮箱已存在| O[提示"该账号已被注册"]
    N -->|通过校验| P[创建用户记录]
    P --> Q[返回"注册成功"]
    
    %% 登录流程
    L --> R1[用户名密码登录]
    L --> R2[手机验证码登录]
    L --> R3[邮箱验证码登录]
    L --> R4[第三方登录]
    
    %% 密码登录
    R1 --> S1[输入用户名]
    S1 --> T1[输入密码]
    T1 --> U1{校验密码}
    U1 -->|错误| V1[错误次数+1]
    V1 --> W1{错误≥5次?}
    W1 -->|是| X1[锁定账号30分钟]
    W1 -->|否| Y1[提示"密码错误"]
    U1 -->|正确| Z1[登录成功]
    
    %% 手机验证码登录
    R2 --> S2[输入手机号]
    S2 --> T2{校验是否存在}
    T2 -->|不存在| U2[提示"该手机未注册"]
    T2 -->|存在| V2[发送短信验证码]
    V2 --> W2[输入验证码]
    W2 --> X2{校验验证码}
    X2 -->|错误/超时| Y2[提示"验证码错误"]
    X2 -->|正确| Z2[登录成功]
    
    %% 邮箱验证码登录
    R3 --> S3[输入邮箱]
    S3 --> T3{校验是否存在}
    T3 -->|不存在| U3[提示"该邮箱未注册"]
    T3 -->|存在| V3[发送邮件验证码]
    V3 --> W3[输入验证码]
    W3 --> X3{校验验证码}
    X3 -->|错误/超时| Y3[提示"验证码错误"]
    X3 -->|正确| Z3[登录成功]
    
    %% 第三方登录
    R4 --> S4[跳转第三方授权]
    S4 --> T4[获取用户信息]
    T4 --> U4{是否已绑定}
    U4 -->|已绑定| V4[自动登录]
    U4 -->|未绑定| W4[提示"请先绑定账号"]
    
    %% 登录后公共流程
    Z1 & Z2 & Z3 & V4 --> AA[生成访问令牌]
    AA --> AB[跳转至首页]
    
    %% 异常状态处理
    X1 --> AC[显示"账号已锁定，请30分钟后重试"]
    Y1 & Y2 & Y3 --> AD[返回登录页并显示错误原因]
    O & U2 & U3 --> AE[返回注册页并提示]
    
    %% 样式定义
    style Q fill:#90EE90,stroke:#006400
    style AB fill:#90EE90,stroke:#006400
    style G1 fill:#FFB6C1,stroke:#8B0000
    style K2 fill:#FFB6C1,stroke:#8B0000
    style AC fill:#FFB6C1,stroke:#8B0000
```

### **流程关键说明**
1. **防重复注册校验**  
   - 用户名/手机/邮箱均需数据库唯一性校验  
   - 第三方账号通过OpenID+平台类型联合唯一索引  

2. **验证码安全规则**  
   - 短信验证码：6位数字，有效期5分钟，同手机号单日最多发送5次  
   - 邮件验证码：8位字母+数字组合，有效期15分钟  
   - 验证码错误3次后需重新获取  

3. **密码安全策略**  
   - 前端传输使用RSA加密  
   - 后端存储采用SHA-256 + 动态盐值（每个用户独立盐值）  

4. **账号锁定机制**  
   - Redis记录错误次数，Key格式：`login_fail:{user_id}`  
   - 锁定后需等待30分钟或通过邮箱验证解锁  

5. **第三方登录流程**  
   - 使用OAuth 2.0协议  
   - 首次登录需强制绑定用户名（防止用户信息缺失）  

6. **令牌生成策略**  
   - JWT令牌有效期7天，包含用户ID和权限标识  
   - 令牌刷新机制：过期前24小时内访问自动续期