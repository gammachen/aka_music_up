# 大数据平台监控与指标模型 DDL 设计

基于您描述的领域模型，我设计了以下MySQL DDL实现方案，重点关注监控系统的核心需求和性能优化：

```sql
-- 服务器表：存储物理/虚拟服务器信息
CREATE TABLE server (
    id VARCHAR(36) NOT NULL COMMENT '服务器唯一标识(UUID)',
    hostname VARCHAR(128) NOT NULL COMMENT '主机名',
    ip_address VARCHAR(45) NOT NULL COMMENT 'IP地址(支持IPv6)',
    os_type ENUM('Linux', 'Windows', 'MacOS', 'BSD', 'Other') NOT NULL COMMENT '操作系统类型',
    os_version VARCHAR(64) NOT NULL COMMENT '操作系统版本',
    cpu_cores SMALLINT UNSIGNED NOT NULL COMMENT 'CPU核心数',
    total_memory BIGINT UNSIGNED NOT NULL COMMENT '总内存(字节)',
    total_disk BIGINT UNSIGNED NOT NULL COMMENT '总磁盘空间(字节)',
    environment ENUM('Production', 'Staging', 'Development', 'Testing') NOT NULL COMMENT '环境类型',
    status ENUM('Active', 'Maintenance', 'Decommissioned', 'Down') NOT NULL DEFAULT 'Active' COMMENT '服务器状态',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
    PRIMARY KEY (id),
    UNIQUE INDEX idx_hostname (hostname),
    INDEX idx_ip (ip_address),
    INDEX idx_environment (environment),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='服务器信息表';

-- 应用表：部署在服务器上的应用程序
CREATE TABLE app (
    id VARCHAR(36) NOT NULL COMMENT '应用唯一标识(UUID)',
    name VARCHAR(128) NOT NULL COMMENT '应用名称',
    version VARCHAR(32) NOT NULL COMMENT '应用版本',
    service_type ENUM('Web', 'Database', 'Queue', 'Cache', 'API', 'Batch', 'ETL') NOT NULL COMMENT '服务类型',
    deploy_status ENUM('Running', 'Stopped', 'Deploying', 'Failed') NOT NULL DEFAULT 'Running' COMMENT '部署状态',
    server_id VARCHAR(36) NOT NULL COMMENT '所属服务器ID',
    start_time TIMESTAMP NULL COMMENT '启动时间',
    last_heartbeat TIMESTAMP NULL COMMENT '最后心跳时间',
    config_path VARCHAR(255) COMMENT '配置文件路径',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
    PRIMARY KEY (id),
    INDEX idx_app_name (name),
    INDEX idx_service_type (service_type),
    INDEX idx_deploy_status (deploy_status),
    FOREIGN KEY (server_id) REFERENCES server(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='应用程序表';

-- 指标元数据表：定义监控指标的基本属性
CREATE TABLE metric_index (
    id VARCHAR(36) NOT NULL COMMENT '指标元数据唯一标识(UUID)',
    name VARCHAR(128) NOT NULL COMMENT '指标名称',
    description TEXT COMMENT '指标描述',
    category ENUM('System', 'Application', 'Network', 'Database', 'Business') NOT NULL COMMENT '指标类别',
    unit VARCHAR(32) NOT NULL COMMENT '计量单位(%, MB, ms, req/s等)',
    data_type ENUM('Gauge', 'Counter', 'Histogram', 'Summary') NOT NULL COMMENT '数据类型',
    aggregation_type ENUM('Avg', 'Sum', 'Min', 'Max', 'Count', 'P99', 'P95') COMMENT '聚合类型',
    retention_period INT UNSIGNED NOT NULL DEFAULT 30 COMMENT '数据保留天数',
    is_enabled BOOLEAN NOT NULL DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
    PRIMARY KEY (id),
    UNIQUE INDEX idx_metric_name (name),
    INDEX idx_category (category),
    INDEX idx_enabled (is_enabled)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='指标元数据表';

-- 指标数据表：存储具体的指标采样值（分区表设计）
CREATE TABLE metric (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '自增主键',
    metric_index_id VARCHAR(36) NOT NULL COMMENT '指标元数据ID',
    server_id VARCHAR(36) COMMENT '关联服务器ID',
    app_id VARCHAR(36) COMMENT '关联应用ID',
    value DOUBLE NOT NULL COMMENT '指标值',
    timestamp TIMESTAMP(3) NOT NULL COMMENT '精确到毫秒的采样时间',
    labels JSON COMMENT '标签信息(JSON格式)',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '入库时间',
    PRIMARY KEY (id, timestamp),
    INDEX idx_metric_timestamp (timestamp),
    INDEX idx_metric_index (metric_index_id),
    INDEX idx_server (server_id),
    INDEX idx_app (app_id),
    FOREIGN KEY (metric_index_id) REFERENCES metric_index(id) ON DELETE CASCADE,
    FOREIGN KEY (server_id) REFERENCES server(id) ON DELETE SET NULL,
    FOREIGN KEY (app_id) REFERENCES app(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='指标数据表'
PARTITION BY RANGE (UNIX_TIMESTAMP(timestamp)) (
    PARTITION p202301 VALUES LESS THAN (UNIX_TIMESTAMP('2023-02-01')),
    PARTITION p202302 VALUES LESS THAN (UNIX_TIMESTAMP('2023-03-01'))
    -- 每月自动增加分区（需要外部脚本维护）
);

-- 告警元数据表：定义告警规则模板
CREATE TABLE alert_index (
    id VARCHAR(36) NOT NULL COMMENT '告警元数据唯一标识(UUID)',
    name VARCHAR(128) NOT NULL COMMENT '告警名称',
    description TEXT COMMENT '告警描述',
    severity ENUM('Critical', 'High', 'Medium', 'Low', 'Info') NOT NULL COMMENT '严重级别',
    metric_index_id VARCHAR(36) NOT NULL COMMENT '关联指标元数据',
    condition_type ENUM('Threshold', 'Anomaly', 'Absence', 'ChangeRate') NOT NULL COMMENT '条件类型',
    condition_config JSON NOT NULL COMMENT '条件配置(JSON格式)',
    duration INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '持续时长(秒)',
    summary_template VARCHAR(255) NOT NULL COMMENT '告警摘要模板',
    description_template TEXT COMMENT '告警详情模板',
    is_enabled BOOLEAN NOT NULL DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
    PRIMARY KEY (id),
    UNIQUE INDEX idx_alert_name (name),
    INDEX idx_severity (severity),
    INDEX idx_enabled (is_enabled),
    FOREIGN KEY (metric_index_id) REFERENCES metric_index(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='告警元数据表';

-- 告警实例表：存储实际触发的告警记录
CREATE TABLE alert (
    id VARCHAR(36) NOT NULL COMMENT '告警实例唯一标识(UUID)',
    alert_index_id VARCHAR(36) NOT NULL COMMENT '告警元数据ID',
    server_id VARCHAR(36) COMMENT '关联服务器ID',
    app_id VARCHAR(36) COMMENT '关联应用ID',
    status ENUM('Firing', 'Resolved', 'Suppressed', 'Acknowledged') NOT NULL DEFAULT 'Firing' COMMENT '告警状态',
    severity ENUM('Critical', 'High', 'Medium', 'Low', 'Info') NOT NULL COMMENT '严重级别',
    start_time TIMESTAMP(3) NOT NULL COMMENT '告警开始时间',
    end_time TIMESTAMP(3) NULL COMMENT '告警结束时间',
    summary VARCHAR(255) NOT NULL COMMENT '告警摘要',
    details TEXT COMMENT '告警详情',
    metric_value DOUBLE COMMENT '触发时的指标值',
    metric_timestamp TIMESTAMP(3) COMMENT '触发时的指标时间',
    labels JSON COMMENT '标签信息(JSON格式)',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
    PRIMARY KEY (id),
    INDEX idx_alert_index (alert_index_id),
    INDEX idx_status (status),
    INDEX idx_severity (severity),
    INDEX idx_start_time (start_time),
    INDEX idx_end_time (end_time),
    FOREIGN KEY (alert_index_id) REFERENCES alert_index(id) ON DELETE CASCADE,
    FOREIGN KEY (server_id) REFERENCES server(id) ON DELETE SET NULL,
    FOREIGN KEY (app_id) REFERENCES app(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='告警实例表';

-- 指标阈值表：为特定实体配置个性化阈值
CREATE TABLE metric_threshold (
    id VARCHAR(36) NOT NULL COMMENT '阈值配置唯一标识(UUID)',
    metric_index_id VARCHAR(36) NOT NULL COMMENT '关联指标元数据',
    server_id VARCHAR(36) COMMENT '关联服务器ID',
    app_id VARCHAR(36) COMMENT '关联应用ID',
    warning_value DOUBLE COMMENT '警告阈值',
    critical_value DOUBLE COMMENT '严重阈值',
    min_value DOUBLE COMMENT '最小值边界',
    max_value DOUBLE COMMENT '最大值边界',
    effective_start DATETIME COMMENT '生效开始时间',
    effective_end DATETIME COMMENT '生效结束时间',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否为默认阈值',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
    PRIMARY KEY (id),
    UNIQUE INDEX idx_unique_scope (metric_index_id, server_id, app_id),
    INDEX idx_metric_index (metric_index_id),
    FOREIGN KEY (metric_index_id) REFERENCES metric_index(id) ON DELETE CASCADE,
    FOREIGN KEY (server_id) REFERENCES server(id) ON DELETE CASCADE,
    FOREIGN KEY (app_id) REFERENCES app(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='指标阈值配置表';
```

## 关键设计说明

### 1. 性能优化设计
- **分区表**：Metric表按时间分区，提升时间范围查询效率
- **索引策略**：
  - 时间戳索引（timestamp）
  - 组合索引（metric_index_id + timestamp）
  - 状态过滤索引（status, severity等）
- **JSON字段**：labels字段使用JSON类型，支持灵活标签查询
- **数据保留**：明确retention_period字段，方便自动化清理

### 2. 监控领域特性
- **精确时间戳**：TIMESTAMP(3)支持毫秒级时间精度
- **指标分类**：区分系统/应用/业务等不同类别指标
- **多级阈值**：支持warning/critical多级告警阈值
- **标签系统**：labels字段支持Prometheus风格的标签体系

### 3. 告警系统设计
- **状态管理**：完整的告警生命周期（Firing→Acknowledged→Resolved）
- **模板化**：summary_template支持动态生成告警信息
- **条件配置**：condition_config存储灵活的告警条件规则
- **关联指标**：记录触发时的实际指标值和时间点

### 4. 可扩展性考虑
- **环境区分**：server.environment支持多环境管理
- **服务类型**：app.service_type区分不同类型应用
- **默认阈值**：metric_threshold.is_default支持全局默认值
- **有效期限**：阈值配置支持时间范围生效

### 5. 数据完整性
- **级联删除**：server/app删除时自动清理关联数据
- **外键约束**：确保数据关联完整性
- **枚举约束**：固定状态字段取值范围

## 示例查询场景

### 1. 获取服务器关键指标
```sql
SELECT s.hostname, m.value, m.timestamp
FROM metric m
JOIN metric_index mi ON m.metric_index_id = mi.id
JOIN server s ON m.server_id = s.id
WHERE mi.name IN ('cpu_usage', 'memory_usage', 'disk_usage')
  AND s.hostname = 'web-server-01'
  AND m.timestamp > NOW() - INTERVAL 1 HOUR
ORDER BY m.timestamp DESC;
```

### 2. 检测当前活跃告警
```sql
SELECT a.summary, s.hostname, a.severity, a.start_time
FROM alert a
LEFT JOIN server s ON a.server_id = s.id
LEFT JOIN app ap ON a.app_id = ap.id
WHERE a.status = 'Firing'
  AND a.start_time > NOW() - INTERVAL 24 HOUR
ORDER BY a.severity DESC, a.start_time DESC;
```

### 3. 阈值违规检测
```sql
SELECT m.server_id, m.value, mt.warning_value, mt.critical_value
FROM metric m
JOIN metric_threshold mt ON m.metric_index_id = mt.metric_index_id
WHERE m.metric_index_id = 'cpu_usage_metric_id'
  AND m.timestamp > NOW() - INTERVAL 5 MINUTE
  AND (
    m.value > mt.critical_value OR
    m.value > mt.warning_value
  );
```

## 建议的扩展功能

1. **历史数据归档**：将旧分区数据迁移到冷存储
2. **自动分区管理**：每月自动创建新分区
3. **标签索引优化**：对labels字段中的常用key创建虚拟列索引
4. **查询缓存**：对元数据表实施缓存策略
5. **分片策略**：当单表过大时，按server/app进行分片

这个设计平衡了监控系统的实时性需求与大数据量存储的挑战，同时提供了足够的灵活性支持不同粒度的监控场景。