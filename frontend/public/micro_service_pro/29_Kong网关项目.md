
## 系统架构

![系统架构](29_API_gateway_architecture.png)

整体架构从分层的角度可以分为四层：

1. **应用层**  
   负责接入拍客服务的业务线，包括 PC 后台、APP、H5 等等。

2. **接入层**  
   主要职能包括流量接入、服务接入和业务接入。  
   - 流量接入主要由负载均衡负责。  
   - Kong 作为业务网关，负责下游服务和业务的接入。

3. **服务层**  
   实现核心能力，包括账号、组织服务、素材相关服务、作品相关服务，以及依赖的其他中台服务。

4. **存储层**  
   负责持久化数据、静态资源、缓存等的存储，包括账号库、组织库、素材库、源站、缓存、消息队列等。

> 拍客自身会依赖多个下游服务，每个服务有自己团队的研发风格，接口协议也千差万别。Kong 除了负责基础的服务治理、路由、流控等，还要负责登录态转换、协议标准化等工作。

---

### 登录态转换

由于各业务线尚未统一 SSO 账号体系，需要打通各业务线与拍客的账号体系。目前通过关联的内容中台 UID 进行转换。  
如需支持非内容中台用户，可通过统一的 Openid 实现。

**转换功能由自研 `bussiness-to-paikeid` 插件完成，主要包含两方面：**

1. 复用现有业务线的身份鉴权，验证登录态用户身份。这样可以让业务线前端专注于业务逻辑开发，有利于拍客的快速推广。
2. 通过关联的内容中台 UID，将业务线的 UID 转换为拍客 UID，并透传给下游服务。透传方式和参数名可配置，适配多种下游服务协议。

![登录态转换](29_网关-登录态转换.png)

**插件执行流程：**

1. 业务线前端透传用户身份标识（如 cookie、token 等）。
2. 插件将身份标识透传到业务线服务端进行身份验证，并查询绑定的内容中台 UID（mediaid）。
3. 通过内容中台 UID 查询拍客系统对应的用户信息，验证是否为拍客账号。
4. 透传拍客 UID 到服务层，透传方式可为 header、query 参数或 body 参数，参数名可自定义。

---

### 协议标准化

为前端提供统一的 API 请求协议和返回协议。  
这些工作本可由单独的接入层完成，但人力成本高、效率低。通过插件（如请求转换、服务器函数、RPC 解析等）可高效完成业务接入。

**主要内容：**

1. **请求协议标准化**  
   在插件处实现下游服务鉴权逻辑，将公网授权转换为内部授权，即登录态验证后的请求直接转为内部请求。

2. **返回协议标准化**  
   修改下游服务的回包结构，兼容不同服务的返回体。统一采用 `{code, msg, data}` 的 JSON 结构，屏蔽服务差异。

![协议标准化](29_网关-协议标准化.png)

**插件执行流程：**

1. 作品数据场景通过 `request-transformer` 插件，透传 pass 中台鉴权参数给数据中台。
2. 素材相关场景通过 `pre-function` 插件，编写鉴权 serverless 函数，并透传签名到素材库中台。
3. 对服务层返回的 RPC 错误进行解析，提取错误码和错误信息，转换为 `{code, msg}` 返回给前端。
4. 对服务层返回的非标准化协议 body 进行修改，统一为 `{code, msg, data}` 结构。

---

如需进一步美化排版或添加小标题、列表等格式，请告知你的具体需求！