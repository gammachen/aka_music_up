### **MySQL Binlog 数据复制详解：异步、半同步、同步**

---

#### **1. 核心概念**
MySQL 的 **Binlog** 是实现主从复制的核心机制，记录了数据库的所有写操作（如 `INSERT`、`UPDATE`、`DELETE`）。主从复制通过主库将 Binlog 传输到从库，从库重放日志以保持数据一致。  
根据 **主库提交事务与从库确认接收** 的逻辑差异，MySQL 提供了以下三种复制模式：

1. **异步复制（Asynchronous Replication）**  
2. **半同步复制（Semi-Synchronous Replication）**  
3. **同步复制（Synchronous Replication）**  

---

#### **2. 三种复制模式的对比**

| **特性**               | **异步复制**                          | **半同步复制**                          | **同步复制**                          |
|------------------------|---------------------------------------|-----------------------------------------|----------------------------------------|
| **数据一致性**         | 低（主库故障可能导致数据丢失）        | 中（至少一个从库确认，降低丢失风险）     | 高（所有从库确认，强一致性）           |
| **延迟**               | 低（主库无需等待从库）                | 中（需等待至少一个从库确认）             | 高（需等待所有从库确认）               |
| **性能影响**           | 最高（无等待）                        | 中（增加少量延迟）                       | 最低（延迟最高）                       |
| **配置复杂度**         | 简单                                  | 中（需配置超时参数）                     | 复杂（需所有从库在线）                 |
| **适用场景**           | 非关键业务（如日志、缓存）            | 金融、电商核心业务                      | 政府、金融强一致性场景                |

---

#### **3. 详细分析与时序图**

##### **3.1 异步复制（Asynchronous Replication）**
- **工作原理**：  
  - 主库提交事务后，**立即返回客户端成功响应**，不等待从库确认。  
  - 从库通过 `I/O Thread` 异步拉取 Binlog，`SQL Thread` 重放日志。  

- **优点**：  
  - **高性能**：主库无等待，适合高写入场景。  
  - **简单易用**：配置简单，网络抖动不影响主库。  

- **缺点**：  
  - **数据丢失风险**：主库故障时，可能丢失未同步到从库的数据。  
  - **主从延迟**：从库可能长时间落后主库。  

- **时序图**：  
  ```mermaid
  sequenceDiagram
    participant Client
    participant Master
    participant Slave

    Client->>Master: 提交事务
    Master->>Master: 写入 Binlog
    Master-->>Client: 返回成功
    Master->>Slave: 异步发送 Binlog
    Slave->>Slave: 写入 Relay Log
    Slave->>Slave: 重放 SQL
  ```

---

##### **3.2 半同步复制（Semi-Synchronous Replication）**
- **工作原理**：  
  - 主库提交事务时，**至少等待一个从库确认接收 Binlog**（写入 Relay Log），再返回成功响应。  
  - 超时后自动降级为异步复制（避免从库故障导致主库阻塞）。  

- **优点**：  
  - **数据安全性**：减少数据丢失风险（至少一个从库有最新数据）。  
  - **折中方案**：在性能与一致性之间取得平衡。  

- **缺点**：  
  - **性能损耗**：增加事务提交延迟（约 10-30ms）。  
  - **配置复杂**：需监控从库状态并动态调整超时参数。  

- **时序图**：  
  ```mermaid
  sequenceDiagram
    participant Client
    participant Master
    participant Slave1
    participant Slave2

    Client->>Master: 提交事务
    Master->>Master: 写入 Binlog
    Master->>Slave1: 发送 Binlog
    Slave1->>Slave1: 写入 Relay Log
    Slave1-->>Master: 返回 ACK
    Master-->>Client: 返回成功
    Master->>Slave2: 异步发送 Binlog
    Slave2->>Slave2: 写入 Relay Log
    Slave2->>Slave2: 重放 SQL
  ```

---

##### **3.3 同步复制（Synchronous Replication）**
- **工作原理**：  
  - 主库提交事务时，**必须等待所有从库确认接收并持久化 Binlog**（写入 Relay Log 并落盘），再返回成功响应。  

- **优点**：  
  - **强一致性**：主从数据实时同步，无延迟。  
  - **高可靠性**：适用于金融交易、核心业务场景。  

- **缺点**：  
  - **性能瓶颈**：延迟极高（取决于最慢从库）。  
  - **单点故障**：任意从库故障会导致主库不可写。  

- **时序图**：  
  ```mermaid
  sequenceDiagram
    participant Client
    participant Master
    participant Slave1
    participant Slave2

    Client->>Master: 提交事务
    Master->>Master: 写入 Binlog
    Master->>Slave1: 发送 Binlog
    Slave1->>Slave1: 写入 Relay Log & 落盘
    Master->>Slave2: 发送 Binlog
    Slave2->>Slave2: 写入 Relay Log & 落盘
    Slave1-->>Master: 返回 ACK
    Slave2-->>Master: 返回 ACK
    Master-->>Client: 返回成功
    Slave1->>Slave1: 重放 SQL
    Slave2->>Slave2: 重放 SQL
  ```

---

#### **4. 影响面与应用场景**

##### **4.1 异步复制**
- **影响面**：  
  - **数据一致性**：主库故障时可能丢失数据。  
  - **延迟容忍度**：适合允许短时延迟的业务。  
- **应用场景**：  
  - 日志系统、缓存预热、非核心业务。  

##### **4.2 半同步复制**
- **影响面**：  
  - **数据一致性**：主库故障时数据丢失窗口 < 1 秒。  
  - **性能损耗**：写入延迟增加约 15%（相比异步）。  
- **应用场景**：  
  - 电商核心交易、金融支付、高一致性要求的业务。  

##### **4.3 同步复制**
- **影响面**：  
  - **数据一致性**：零数据丢失（RPO=0）。  
  - **性能瓶颈**：写入延迟可能高达数百毫秒。  
- **应用场景**：  
  - 政府机密数据、证券交易、强一致性分布式系统。  

---

#### **5. 总结与选型建议**
| **需求**              | **推荐模式**       | **理由**                                                                 |
|-----------------------|--------------------|--------------------------------------------------------------------------|
| **高性能**            | 异步复制           | 无等待，适合高并发写入场景。                                             |
| **数据一致性**        | 同步复制/半同步    | 同步复制强一致性，半同步折中方案。                                       |
| **容灾能力**          | 半同步复制         | 降低数据丢失风险，同时避免性能过度损耗。                                 |
| **成本敏感型场景**    | 异步复制           | 无需额外资源投入，适合预算有限的业务。                                   |

---

#### **6. 增强半同步复制（Enhanced Semi-Synchronous）**
- **改进点**：  
  - **并行 ACK**：支持多个从库同时确认。  
  - **动态超时调整**：通过 `rpl_semi_sync_master_timeout` 动态控制降级策略。  
  - **AFTER_SYNC/AFTER_COMMIT**：  
    - `AFTER_SYNC`：主库等待从库写入 Relay Log 并落盘。  
    - `AFTER_COMMIT`：主库等待从库写入 Relay Log 即可。  

- **性能对比**：  
  | 模式             | TPS（万/秒） | 平均延迟（ms） |  
  |------------------|--------------|----------------|  
  | 异步             | 12.4         | 3.2            |  
  | 传统半同步       | 8.7          | 18.5           |  
  | 增强半同步       | 10.2         | 12.3           |  

---

通过合理选择复制模式，可以平衡 **性能、一致性、可靠性** 三者之间的关系，满足不同业务场景的需求。