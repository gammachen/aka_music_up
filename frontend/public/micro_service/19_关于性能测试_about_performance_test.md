# 系统性能压测指南

## 1. 性能压测概述

在大促来临之前，研发人员需要对现有系统进行梳理，发现系统瓶颈和问题，然后进行系统调优来提升系统的健壮性和处理能力。一般通过系统压测来发现系统瓶颈和问题，然后进行系统优化和容灾(如系统参数调优、单机房容灾、多机房容灾等)。即使已经把系统优化和容灾做得非常好了，但也存在一些不稳定因素，如网络、依赖服务的SLA不稳定等，这就需要我们制定应急预案，在出现这些因素后进行路由切换或降级处理。在大促之前需要进行预案演习，确保预案的有效性。

### 1.1 什么是压测

压测一般指性能压力测试，用来评估系统的稳定性和性能，通过压测数据进行系统容量评估，从而决定是否需要进行扩容或缩容。

### 1.2 压测流程

完整的压测流程包括以下几个步骤：

1. **制定压测方案**：确定压测接口、并发量、压测策略（突发、逐步加压、并发量）、压测指标（机器负载、QPS/TPS、响应时间）
2. **执行压测**：按照压测方案执行压测，收集数据
3. **产出压测报告**：包含压测方案、机器负载、QPS/TPS、响应时间（平均、最小、最大）、成功率、相关参数（JVM参数、压缩参数）等
4. **分析优化**：根据压测报告分析结果进行系统优化和容灾

## 2. 压测指标定义

### 2.1 核心指标

在进行性能压测时，需要关注以下核心指标：

1. **吞吐量指标**
   - QPS（每秒查询数）：系统每秒能够处理的查询请求数量
   - TPS（每秒事务数）：系统每秒能够处理的事务数量
   - RPS（每秒请求数）：系统每秒能够处理的HTTP请求数量

2. **响应时间指标**
   - 平均响应时间：所有请求的平均响应时间
   - TP90/TP95/TP99：90%/95%/99%的请求响应时间
   - 最大响应时间：请求的最大响应时间

3. **资源利用率指标**
   - CPU使用率：CPU的使用百分比
   - 内存使用率：内存的使用百分比
   - 磁盘I/O：磁盘读写速率
   - 网络I/O：网络传输速率

4. **错误率指标**
   - 请求成功率：成功请求数/总请求数
   - 错误请求数：各类错误请求的数量统计

### 2.2 指标收集方法

1. **系统级指标收集**
   - 使用`top`、`vmstat`、`iostat`等命令实时监控系统资源使用情况
   - 使用Prometheus + Grafana等监控工具进行可视化监控

2. **应用级指标收集**
   - 使用JMX监控Java应用性能
   - 使用APM工具（如SkyWalking、Pinpoint）进行应用性能监控
   - 使用ELK（Elasticsearch、Logstash、Kibana）进行日志分析

## 3. 线下压测

### 3.1 线下压测工具

#### 3.1.1 JMeter

Apache JMeter是一款开源的压测工具，支持多种协议，如HTTP、HTTPS、SOAP、REST、FTP、JDBC等。

**JMeter使用步骤**：

1. 创建测试计划（Test Plan）
2. 添加线程组（Thread Group）
3. 添加HTTP请求（HTTP Request）
4. 添加监听器（Listener）
5. 运行测试

**JMeter关键配置**：

```
线程数：模拟的并发用户数
循环次数：每个线程执行的次数
启动时间：线程启动的时间间隔
定时器：请求之间的延迟时间
断言：验证响应是否符合预期
```

#### 3.1.2 Apache Bench (ab)

Apache Bench是一个简单的命令行工具，用于测量HTTP服务器的性能。

**ab使用示例**：

```bash
# 向目标URL发送1000个请求，并发数为100
ab -n 1000 -c 100 http://example.com/

# 测试10秒，并发数为100
ab -t 10 -c 100 http://example.com/

# 使用POST请求，并指定请求体
ab -n 1000 -c 100 -p post.txt -T application/json http://example.com/api
```

### 3.2 线下压测局限性

线下压测的环境（服务器、网络、数据量等）和线上的完全不一样，仿真度不高，很难进行全链路压测，适合组件级的压测，数据只能作为参考。主要局限包括：

1. 环境差异：线下环境通常无法完全模拟线上环境
2. 数据差异：线下测试数据与线上真实数据存在差异
3. 网络环境：线下网络环境与线上网络环境不同
4. 依赖服务：线下难以模拟所有依赖服务的真实行为

## 4. 线上压测

### 4.1 线上压测分类

线上压测的方式非常多，可以从不同维度进行分类：

1. **按读写类型分类**
   - 读压测：压测系统的读流量，如商品价格查询服务
   - 写压测：压测系统的写流量，如下单服务
   - 混合压测：同时压测读写流量，更接近真实场景

2. **按数据仿真度分类**
   - 仿真压测：通过模拟请求进行系统压测
   - 引流压测：复制线上真实流量进行压测

3. **按是否影响用户分类**
   - 隔离集群压测：在独立的压测集群上进行
   - 线上集群压测：直接在线上集群进行压测

### 4.2 TCPCopy工具使用指南

TCPCopy是一个实用的流量复制工具，可以将线上流量复制到测试环境，用于性能测试、稳定性测试等场景。

#### 4.2.1 TCPCopy安装

**在源服务器上安装**：

```bash
# 安装依赖
yum install -y libpcap-devel libnet-devel

# 下载并编译TCPCopy
git clone https://github.com/session-replay-tools/tcpcopy.git
cd tcpcopy
./configure --prefix=/usr/local/tcpcopy
make
make install
```

**在目标服务器上安装拦截器**：

```bash
cd tcpcopy/intercept/
./configure --prefix=/usr/local/tcpcopy
make
make install
```

#### 4.2.2 TCPCopy使用方法

**在目标服务器上启动拦截器**：

```bash
/usr/local/tcpcopy/bin/intercept -i eth0 -F "tcp and port 8080" -d
```

**在源服务器上启动TCPCopy**：

```bash
# 基本用法：复制80端口流量到目标服务器的8080端口
/usr/local/tcpcopy/bin/tcpcopy -x 80-192.168.0.100:8080 -s 192.168.0.100 -d

# 放大流量10倍
/usr/local/tcpcopy/bin/tcpcopy -x 80-192.168.0.100:8080 -s 192.168.0.100 -d -r 10

# 只复制特定IP范围的流量
/usr/local/tcpcopy/bin/tcpcopy -x 80-192.168.0.100:8080 -s 192.168.0.100 -d -c 192.168.1.0/24
```

#### 4.2.3 TCPCopy最佳实践

1. **流量控制**：使用`-r`参数控制流量放大倍数，建议从小倍数开始，逐步增加
2. **网络带宽**：确保源服务器和目标服务器之间有足够的网络带宽
3. **监控系统**：在使用TCPCopy时，同时监控源系统和目标系统的资源使用情况
4. **数据隔离**：确保测试环境中的写操作不会影响生产数据
5. **会话处理**：对于需要会话的应用，使用`-u`参数保持用户会话一致性

### 4.3 影子库构建方案

影子库（Shadow Database）是线上压测中保证数据安全的重要技术，它可以将线上的写操作引导到一个影子数据库中，避免影响真实数据。

#### 4.3.1 影子库架构

影子库架构通常包含以下组件：

1. **流量标记**：在请求中添加特殊标记，标识为压测流量
2. **路由层**：根据流量标记将请求路由到影子库或生产库
3. **影子数据库**：与生产数据库结构相同，但数据独立的数据库实例
4. **数据同步**：从生产库到影子库的只读数据同步机制

#### 4.3.2 影子库实现方案

**方案一：数据库代理层实现**

```
客户端 -> 代理层(识别压测标记) -> 影子库/生产库
```

1. 在应用请求中添加压测标记（如HTTP头部`X-Test-Flag: true`）
2. 数据库代理层（如MyCat、ShardingSphere）识别标记
3. 根据标记将SQL请求路由到影子库或生产库

**方案二：应用层实现**

```
客户端 -> 应用层(识别压测标记) -> 影子库/生产库
```

1. 在应用中实现动态数据源切换功能
2. 根据请求标记选择不同的数据源
3. 使用AOP或拦截器实现透明的数据源切换

**示例代码（基于Spring）**：

```java
@Aspect
@Component
public class ShadowDatabaseAspect {
    
    @Autowired
    private DynamicDataSourceHolder dataSourceHolder;
    
    @Around("execution(* com.example.service.*.*(..))")  
    public Object routeDataSource(ProceedingJoinPoint joinPoint) throws Throwable {
        // 获取当前请求上下文
        ServletRequestAttributes attributes = 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();
        
        // 检查是否包含压测标记
        String testFlag = request.getHeader("X-Test-Flag");
        if ("true".equals(testFlag)) {
            // 切换到影子库
            dataSourceHolder.setDataSource("shadowDataSource");
        } else {
            // 使用生产库
            dataSourceHolder.setDataSource("productionDataSource");
        }
        
        try {
            return joinPoint.proceed();
        } finally {
            // 清除数据源设置
            dataSourceHolder.clearDataSource();
        }
    }
}
```

#### 4.3.3 影子库数据同步

影子库需要与生产库保持一定程度的数据同步，常用的同步方案包括：

1. **定时全量同步**：适用于数据量较小的场景
2. **增量同步**：通过binlog、CDC等技术实现增量数据同步
3. **按需同步**：只同步压测需要的数据

**使用Canal进行数据同步示例**：

```bash
# 配置Canal连接生产MySQL
canal.instance.master.address=production-db:3306
canal.instance.dbUsername=canal
canal.instance.dbPassword=canal
canal.instance.filter.regex=.*\.(table1|table2)

# 启动Canal服务
bin/startup.sh

# 在消费端处理数据并写入影子库
# 示例代码略
```

## 5. 压测策略与最佳实践

### 5.1 单机压测与集群压测

**单机压测**是指对集群中的一台机器进行压测，从而评估出单机极限处理能力，发现单机的瓶颈点，这样可以把单机性能优化到极致。

**集群压测**是对整个服务集群进行压测，评估集群的极限处理能力，发现集群瓶颈（通常是依赖的系统或服务，如数据库、缓存或调用的服务）。

### 5.2 离散压测

在压测时，应该选择离散压测，即选择的数据应该是分散的或者长尾的。例如：

- 刚刚新增的商品一般在缓存中，是热点数据
- 去年已经下架的商品可能已经从缓存中移除，是冷数据

如果压测的数据只是热点数据，则不能反映出系统的真实处理能力。离散压测能够更全面地测试系统性能。

### 5.3 全链路压测

全链路压测是指对整个业务流程进行端到端的压测，包括所有相关的服务和组件。全链路压测的重要性：

1. 发现非核心系统的问题：可能存在一个非核心系统服务调用问题造成整个交易链路出现问题
2. 发现资源竞争：链路中的各个系统可能存在竞争资源的情况
3. 真实性保证：只有全链路压测才能真实反映系统在生产环境中的表现

### 5.4 压测安全措施

在进行线上压测时，需要采取以下安全措施：

1. **数据隔离**：使用影子库、影子表等技术隔离压测数据
2. **流量标记**：为压测流量添加明显标记，便于识别和控制
3. **限流措施**：设置压测流量上限，防止系统过载
4. **监控告警**：加强监控，设置合理的告警阈值
5. **应急预案**：制定压测过程中的应急处理预案
6. **分时段执行**：选择业务低峰期进行压测
7. **逐步加压**：从小流量开始，逐步增加压测强度

## 6. 压测报告与分析

### 6.1 压测报告模板

一个完整的压测报告应包含以下内容：

1. **压测概述**
   - 压测目标和范围
   - 压测环境说明
   - 压测时间和持续时间

2. **压测配置**
   - 压测工具和版本
   - 压测脚本或场景
   - 并发用户数和压测策略

3. **性能指标**
   - 吞吐量（QPS/TPS）
   - 响应时间（平均、TP90、TP99、最大）
   - 错误率和错误分布

4. **资源使用情况**
   - CPU使用率
   - 内存使用率
   - 磁盘I/O
   - 网络I/O

5. **瓶颈分析**
   - 性能瓶颈点
   - 资源瓶颈点
   - 代码瓶颈点

6. **优化建议**
   - 短期优化措施
   - 中长期优化计划

### 6.2 性能瓶颈分析方法

1. **自顶向下分析法**
   - 从整体系统表现开始分析
   - 逐层深入到具体组件
   - 定位瓶颈点

2. **USE方法（Utilization, Saturation, Errors）**
   - 检查资源利用率
   - 检查资源饱和度
   - 检查错误指标

3. **火焰图分析**
   - 使用性能分析工具生成火焰图
   - 分析CPU使用情况和调用栈
   - 找出热点代码

## 7. 总结

系统性能压测是保障系统稳定性和性能的重要手段。通过合理的压测策略、工具选择和数据分析，可以有效发现系统瓶颈，优化系统性能，提升系统的健壮性和处理能力。在大促等高流量场景前，进行全面的性能压测和优化，是确保系统稳定运行的关键步骤。