# 数据库分库分表策略详解

## 策略选择原则

分库分表策略是指按照什么算法或规则进行存储，它会影响数据的写入和读取。例如，按照订单ID分库分表，那么就很难按照客户维度进行订单查询。因此，在进行分库分表时需要慎重考虑使用什么策略。

> **重要提示**：分库分表策略选择会直接影响查询效率和扩展性，应基于业务访问模式做出合理选择。

## 常见分库分表策略

常见的策略有取模、分区、路由表等。下面将详细介绍各种策略的特点及应用场景。

### 1. 取模策略

取模是最常见的分片策略，可以较好地分散数据分布。

#### 实现方式

- 按照数值型主键取模进行分库分表
- 按照字符串主键哈希取模进行分库分表

#### 应用场景

常见应用场景包括：
- 订单表按照订单ID分库分表
- 用户订单表按照用户ID分库分表
- 产品表按照产品ID分库分表

#### 优缺点

**优点**：
- 数据热点分散，负载均衡
- 数据分布均匀

**缺点**：
- 按照非主键维度进行查询时需要跨库/跨表查询
- 扩容需要建立新集群并进行数据迁移

#### 扩容策略

为减少扩容时带来的麻烦，可以采取以下策略：

1. **初期规划冗余**：
   - 在初期规划时冗余足够数量的分库分表
   - 例如：一年规划只需要分2个库4个表，可以冗余设计为4个库8个表
   - 分布方式：0-1库在机器1，2-3库在机器2
   
2. **性能问题处理**：
   - 遇到性能问题时可以把1、3库移到新的机器上
   
3. **容量问题解决方案**：
   - 首先通过硬件升级解决：
     - HDD换成SATA SSD
     - SATA SSD换成PCIe SSD或NVMe SSD
   - 硬件升级后可能遇到的瓶颈：
     - 磁盘空间
     - 网卡带宽
   - 通过扩容物理机来解决持续的性能瓶颈

#### 成倍扩容实现

当单表容量遇到瓶颈，可以进行成倍扩容（如4个库扩容为8个库）：

1. **扩容步骤**：
   - 挂数据库主从(如order_4->order_0)
   - 等待数据库主从同步完成
   - 停应用写数据库并等待一段时间以保证主从同步完成
   - 更新分库分表规则并启动应用进行写库
   - 最后删除各个库的冗余数据

> **注意**：分库数量不是越多越好，需要根据实际业务需求和系统负载合理规划。

### 2. 分区策略

分区策略是按照一定规则将数据分到不同区域的方法。

#### 分区方式

- **时间分区**：如一个月一个表、一年一个库
- **范围分区**：如0~200万一个表，200~400万一个表

#### 复杂分区处理

如果分区规则很复杂，则可以有一个路由表来存储分库分表规则。

#### 优缺点

**优点**：
- 易于水平扩展
- 能避免数据迁移
- 适合时间序列或范围明确的数据

**缺点**：
- 存在数据热点问题
- 不同分区的数据量可能差异较大

#### 组合策略

也可以采用取模+分区组合使用，以结合两种策略的优点。

### 3. Sharding-JDBC分库分表实现

Sharding-JDBC提供了一种简便的方式来实现分库分表，它是当当网开源的分库分表中间件。

> Sharding-JDBC的详细配置和使用方法可以参考其官方文档，这里不做展开。
