# 数据库分库分表实现策略

## 5. 数据库分库分表示例

数据库分库分表后就会涉及如何写入和读取数据的问题，应用开发人员主要关心如下几个问题：

* 是否需要在应用层做改造来支持分库分表，即是在应用层进行支持，还是通过中间件层呢?
* 如果需要应用层做支持，那么分库分表的算法是什么?
* 分库分表后，join是否支持，排序分页是否支持，事务是否支持。

## 应用层与中间件层对比

### 实现方式选择

分库分表可以在应用层实现，也可以在中间件层实现，中间件层实现的好处是对应用透明，应用就像查单库单表一样去查询中间件。

### 中间件层实现的优缺点

**优点：**
- 对应用透明，无需修改应用代码
- 支持多种编程语言，而不受限于特定的语言
- 减少应用的总数据库连接数，从而避免因为应用过多导致数据库连接不够用

**缺点：**
- 除了维护中间件外，还要考虑中间件的HA/负载均衡等，增加了系统复杂度

## 主流开源数据库中间件比较

### 中间件层实现

目前开源的数据库中间件主要有：

1. **Atlas (奇虎360)**
   - 基于MySQL-Proxy开发
   - 功能支持：
     - 分表或分库(sharding版本)
     - 读写分离
   - 限制：
     - 不支持跨库分表(如分3个库每个库3张表)
     - sharding版本不支持跨库操作(跨库事务/跨库join等)

2. **Cobar (阿里)**
   - 功能支持：
     - 支持分库
   - 限制：
     - 不支持分表(如每个库3个表)
     - 不支持跨库join/分页/排序等

3. **MyCat**
   - 基于Cobar开发
   - 功能支持：
     - 分库分表
     - 读写分离
     - 跨库弱事务支持
     - 对跨库join等有限支持(内存聚合)
   - 数据库支持：
     - 主要支持MySQL
     - 也提供了对Oracle等数据库的支持

> 京东内部也有很多分库分表实现，还有如JProxy分布式数据库实现，截止本书出版前暂未开源。

### 应用层实现

应用层的分库分表实现通常在以下层次完成：

1. **JDBC驱动层**
   - 如当当的sharding-jdbc

2. **DAO框架层**
   - 如iBatis/Mybatis/Hibernate/JPA
   - 阿里的cobar-client是基于DAO框架iBatis实现

## Sharding-JDBC详解

### 基本介绍

当当开源的Sharding-JDBC具有以下特点：

- 直接封装JDBC API，迁移成本很低
- 可以对iBatis、MyBatis、Hibernate、JPA等DAO框架提供支持
- 目前只提供了MySQL的支持，未来计划支持如Oracle等数据库

### 功能支持

Sharding-JDBC支持以下功能：

- 分库分表
- 读写分离
- 跨库join/分页/排序等
- 弱事务
- 柔性事务(最大努力送达)

