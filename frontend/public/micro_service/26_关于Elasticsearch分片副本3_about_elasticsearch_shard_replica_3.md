以下是对 Elasticsearch 分片写入机制、查询逻辑及分片路由策略的详细分析：

---

### **一、分片如何提升写入吞吐量？**
#### **1. 分片作为写入的最小单元**
- **写入流程**：
  1. 客户端写入文档时，协调节点（Coordinating Node）根据文档的 **路由规则**（默认基于 `_id` 的哈希值）确定文档应写入哪个分片。
  2. 文档被发送到目标分片的主分片（Primary Shard）所在节点。
  3. 主分片写入成功后，数据同步到副本分片（Replica Shard）。

- **吞吐量提升的本质**：
  - **并行写入**：不同分片的主分片分布在不同的节点上（如Node1和Node2），每个节点可独立处理各自分片的写入请求。
  - **资源分散**：
    - **磁盘IO**：单节点磁盘IO瓶颈被分摊到多个节点。
    - **CPU/内存**：索引文档时的分词、分析、压缩等计算操作分散到多个节点。

#### **2. 示例说明**
假设有 **2个分片**（Shard0在Node1，Shard1在Node2）：
- **单分片写入场景**：
  - 所有文档写入单个分片（如Shard0），Node1需处理所有写入负载，Node2空闲。
  - 写入吞吐量受限于Node1的磁盘IO和CPU。
- **2分片写入场景**：
  - 文档按路由规则分散到Shard0（Node1）和Shard1（Node2）。
  - Node1和Node2的磁盘IO和CPU资源被同时利用。
  - 理论最大写入吞吐量接近 **单节点的2倍**。

#### **3. 关键结论**
- 分片数越多，写入吞吐量越高（前提是分片分布在不同的物理节点）。
- 但分片过多会导致资源碎片化（如3个节点设置100个分片），反而降低性能。

---

### **二、查询是否必须广播到所有分片？**
#### **1. 默认查询逻辑**
- **广播式查询**：
  - 协调节点将查询请求发送到索引的 **所有分片**（包括主分片和副本分片）。
  - 每个分片独立执行查询并返回局部结果。
  - 协调节点合并所有分片的结果（排序、分页、聚合等）。
- **优点**：简单通用，适用于任意查询条件。
- **缺点**：合并结果需要额外网络传输和CPU计算。

#### **2. 优化方法：路由（Routing）**
- **自定义路由键**：
  - 写入文档时指定 `routing` 参数（如 `routing=product_category`）。
  - 查询时指定相同的 `routing` 参数，Elasticsearch 仅查询关联的分片。
  ```bash
  # 写入时指定路由
  PUT /products/_doc/1?routing=electronics
  { "title": "Smartphone" }

  # 查询时指定路由
  GET /products/_search?routing=electronics
  {
    "query": { "match": { "title": "Smartphone" } }
  }
  ```
- **效果**：
  - 查询仅发送到与 `routing` 值关联的分片，减少广播范围。
  - 合并开销降低，查询性能显著提升。

#### **3. 路由机制原理**
- 分片选择公式：
  ```
  shard_num = hash(routing_value) % number_of_primary_shards
  ```
- **示例**：
  - 索引有2个主分片，`routing=electronics` 的哈希值为12345。
  - 分片号 = 12345 % 2 = 1 → 文档写入Shard1。

---

### **三、数据插入时如何确定写入哪个分片？**
#### **1. 分片选择流程**
1. **客户端发送文档**：向任意节点（协调节点）发送写入请求。
2. **计算路由值**：
   - 默认使用文档的 `_id` 字段计算哈希值。
   - 若指定 `routing` 参数，则使用 `routing` 值计算哈希值。
3. **确定目标分片**：
   - 根据公式 `shard_num = hash(routing_value) % number_of_primary_shards` 选择分片。
4. **转发到主分片**：
   - 协调节点将文档转发到目标分片的主分片所在节点。
   - 主分片写入成功后，同步到副本分片。

#### **2. 分片分布示例**
- **索引配置**：
  ```bash
  PUT /products
  {
    "settings": {
      "number_of_shards": 2,
      "number_of_replicas": 1
    }
  }
  ```
- **分片分布**：
  - Shard0（主分片）在Node1，副本在Node2。
  - Shard1（主分片）在Node2，副本在Node1。
- **写入流程**：
  - 文档A路由到Shard0 → 写入Node1的主分片，同步到Node2的副本。
  - 文档B路由到Shard1 → 写入Node2的主分片，同步到Node1的副本。

---

### **四、性能权衡与生产建议**
#### **1. 写入性能优化**
- **合理分片数**：分片数应与节点数匹配（如3节点设置3分片）。
- **SSD磁盘**：提升单分片的写入速度。
- **批量写入（Bulk API）**：减少单个请求的开销。

#### **2. 查询性能优化**
- **避免过度分片**：分片过多会增加合并开销。
- **使用路由**：定向查询特定分片，减少广播范围。
- **冷热分离**：将历史数据迁移到冷节点，减少活跃分片数量。

#### **3. 监控与调整**
- **观察分片负载**：
  ```bash
  GET _cat/shards/products?v
  ```
- **调整分片分布**：
  ```bash
  POST /_cluster/reroute
  {
    "commands": [
      { "move": { "index": "products", "shard": 0, "to_node": "node3" } }
    ]
  }
  ```

---

### **五、总结**
- **分片提升写入吞吐量**：通过分散写入负载到多个节点的物理资源。
- **查询默认广播到所有分片**：但可通过路由优化减少查询范围。
- **分片路由依赖哈希计算**：写入时由 `routing` 值确定目标分片。

合理设计分片数、路由策略及副本分布，是平衡Elasticsearch读写性能的关键。