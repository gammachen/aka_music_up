# 系统扩容策略

## 扩容背景

对于这样一个系统，随着产品使用的用户越来越多，网站的流量会增加，最终单台服务器无法处理那么大的流量，此时就需要用分而治之的思想来解决问题。

## 扩容策略

扩容通常遵循以下三步策略：

1. **第一步**：尝试通过简单扩容来解决。

2. **第二步**：如果简单扩容搞不定，就需要水平拆分和垂直拆分数据/应用来提升系统的伸缩性，即通过扩容提升系统负载能力。

3. **第三步**：如果通过水平拆分/垂直拆分还是搞不定，那就需要根据现有系统特性，从架构层面进行重构甚至是重新设计，即推倒重来。

> 对于系统设计，理想的情况下应支持线性扩容和弹性扩容，即在系统瓶颈时，只需要增加机器就可以解决系统瓶颈，如降低延迟提升吞吐量，从而实现扩容需求。

如果你想扩容，则支持水平/垂直伸缩是前提。在进行拆分时，一定要清楚知道自己的目的是什么，拆分后带来的问题如何解决，拆分后如果没有得到任何收益就不要为了拆而拆，即不要过度拆分，要适合自己的业务。本章主要从应用和数据层面讲解如何按照业务和功能进行应用或数据层面的拆分。

## 单体应用扩容方式

### 垂直扩容

有些时候，如果能通过硬件快速解决，而且成本不高，应该首先通过硬件扩容来解决问题。硬件扩容包括：

- **升级现有服务器**：
  - CPU由原来的32核升级到64核
  - 内存从64GB升级到256GB（有的缓存服务器CPU利用率很低，但是内存不够用，就通过扩容内存来提升单机容量）

- **磁盘扩容**：
  - 系统有大量的随机读写，因此把HDD换成SSD
  - 将原来单机1TB扩容为2TB
  - 原来硬盘做了RAID 10，现在直接拆为裸盘使用，通过架构层面提升数据可靠性

- **其他硬件升级**：
  - 核心数据库可以使用PCIe SSD或NVMe SSD
  - 千兆网卡可以升级为万兆网卡

> 不管怎么扩容，单机总会是瓶颈，而分布式技术是提升系统扩容能力的更好方法。

### 水平扩容

单体系统水平扩容是通过部署更多的镜像来实现的。原来通过一个系统实例对外提供服务，通过扩容到更多实例后，用户访问时不可能提供多个域名/IP入口，应该提供统一入口，此时就需要负载均衡机制来实现。

**水平扩容的关键考虑点**：

- **会话处理**：如果用户会话数据分散在应用系统，就需要在负载均衡器开启会话黏滞特性。

- **读写分离**：如果数据库的瓶颈是读造成的，则此时可以通过主从数据库架构将读的流量分散到更多的从服务器上，写数据时写到主数据库，读数据时读取从数据库。

> 经过单体应用的垂直/水平扩容，如果系统还是有瓶颈，则此时只有通过拆分应用来解决。

## 应用拆分策略

### 业务维度拆分

对于单体应用来说，随着业务量的增加，一个大系统就会有很多人维护，这就造成修改代码会出现冲突，上线必须大家一起上线，而且风险较大，导致需求实现速度缓慢。因此单体应用发展到一定地步时，会按照业务进行拆分。

**拆分方式**：
- 按照业务将一个大系统拆分为多个子系统，比如网站系统和交易系统
- 拆分时要进行业务代码解耦，将功能分离到不同系统上
- 拆分后系统之间是物理隔离的，应用层面原来是直接进程内方法调用，现在需要改成远程方法调用，比如通过WebService, RMI等

### 功能域拆分

随着系统流量越来越大，我们会继续在业务拆分基础上，按照功能域拆分为前端Web系统和基础服务。因为随着业务的发展，流量越来越大，解决方案越来越复杂：

- 商品、购物车、结算服务会趋于基础化、通用化
- 前端Web会有各种各样的版本和需求，如PC/APP/H5/开放平台等

因此需要进行服务化平台与业务系统的拆分。

**服务化架构**：
- 拆分后，系统之间需要使用带服务注册/发现功能的SOA框架来进行交互，如Dubbo
- 服务化后，服务提供者可以根据当前网站状况随时扩容
- 通过服务注册中心，服务消费者不需要进行任何配置的更改，就可以发现新的服务提供者并使用它

> 一般情况下，中等互联网公司会发展为如上服务化架构风格，系统之间通过SOA服务进行互动，按照不同的业务、功能进行系统拆分，并交由不同的团队维护。

### 基础服务进一步拆分

像商品这种基础服务，有非常多的系统依赖它。随着访问量的增加，尤其像单个读/单个写/条件查询这类访问，会因为某一种操作出现异常造成其他操作不可用。因此，我们需要把这些操作进行拆分，拆分到不同的服务中，从而使写出现问题时不会影响到读。

**数据一致性考虑**：
- 因为进行了系统拆分，主数据库向缓存/ES同步时会有一定的延迟
- 如果需要强一致性的读，那么直接读主库
- 不是所有的系统都需要读主库，要做出限制

**数据库连接管理**：
- 随着应用部署数量的增多，数据库连接也会成为瓶颈
- 一般会通过主从架构提升连接数
- 也可以使用MyCat/Corbar这种数据库中间件提升连接数
- 所有应用只调用读/写服务中间件，由读/写服务中间件访问数据库，减少整体的连接数
- 通过MQ异构数据，从而不访问有瓶颈的数据库

## 系统架构进阶

### 接入层构建

随着流量变大，缓存、限流、防刷需求变得越来越多，此时可以将缓存/限流/防刷从各应用系统中拆出来，放到单独系统实现，即接入层。

### 多机房部署

随着网站发展，对网站的性能、可用性要求越来越高：
- 对于前端页面型应用需要引进CDN功能
- 业务系统要支持多机房多活

**多机房优势**：
- 当其中一个机房出问题时，应该能比较快速地切换到另一个机房
- 使用BIND可以根据用户IP将不同区域的用户路由到离他最近的机房来提供服务，从而减少访问延迟

## 总结

通过应用拆分和服务化后，扩容变得更加容易，如系统处理能力跟不上，只需要增加服务器即可。