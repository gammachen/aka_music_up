# 数据库等价谓词重写技术详解

## 引言

等价谓词重写是数据库查询优化的重要技术之一，它通过将SQL查询中的谓词表达式重写为语义等价但执行效率更高的形式，从而提高查询性能。数据库执行引擎对不同谓词的处理效率存在差异，某些谓词形式能更好地利用索引或减少计算量。本文将系统地介绍常见的等价谓词重写规则、原理及其在实际数据库系统中的应用。

## 表1-1 等价谓词重写技术概览

| 重写规则 | 原始谓词形式 | 重写后谓词形式 | 优化原理 | 性能提升 |
| ------- | ---------- | ------------ | ------- | ------- |
| LIKE规则 | name LIKE 'Abc%' | name>='Abc' AND name<'Abd' | 利用索引范围扫描代替全表扫描 | 显著 |
| BETWEEN-AND规则 | sno BETWEEN 10 AND 20 | sno>=10 AND sno<=20 | 利用索引范围扫描代替全表扫描 | 中等 |
| IN转换OR规则 | age IN (8,12,21) | age=8 OR age=12 OR age=21 | 可能利用索引进行优化 | 中等 |
| IN转换ANY规则 | age IN (8,12,21) | age=ANY(8,12,21) | 依赖数据库对ANY操作的支持 | 中等 |
| OR转换ANY规则 | 复杂OR表达式 | 简化的ANY表达式 | 利用MIN/MAX操作进行优化 | 中等 |
| ALL/ANY转换集函数规则 | sno>ANY(10, 2*5+3, sqrt(9)) | sno>sqrt(9) | 利用聚集函数提高效率 | 中等 |
| NOT规则 | NOT (col_1 != 2) | col_1 = 2 | 简化表达式，可能利用索引 | 低到中等 |
| OR重写并集规则 | 复杂OR条件 | UNION操作 | 分别利用索引后合并结果 | 显著 |

## 1. LIKE规则

LIKE谓词是SQL标准支持的一种模式匹配比较操作，在查询中广泛使用。然而，当LIKE谓词中包含通配符时，数据库通常无法有效利用索引，导致全表扫描。LIKE规则通过将特定模式的LIKE谓词重写为范围比较操作，使查询能够利用索引提高性能。

### 1.1 基本原理

LIKE规则的核心思想是将以固定前缀开头、后跟通配符的LIKE表达式转换为等价的范围比较表达式。这种转换使得数据库可以利用索引进行范围扫描，而不是全表扫描。

### 1.2 重写规则

**规则1：前缀匹配转换为范围比较**

当LIKE表达式形如 `column LIKE 'prefix%'` 时，可以重写为：

```sql
column >= 'prefix' AND column < 'prefix字典序后继'
```

其中，"prefix字典序后继"是指在字符集中紧跟在"prefix