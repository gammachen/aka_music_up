# MySQL基准测试的建议与注意事项

## 基准测试的局限性

你也许期望通过建立一套基准测试方案，然后不断迭代地验证对配置项的修改来找到最佳配置方案。通常我们都不建议大家这么做，原因如下：

- 这需要做非常多的工作和研究，而大部分情况下潜在的收益非常小，可能导致巨大的时间浪费
- 把时间花在检查备份、监控执行计划的变动等事情上，可能会更有意义
- 即使更改一个选项后基准测试出现了提升，也无法知道长期运行后这个变更会有什么副作用
- 基准测试不能衡量一切，或者没有运行足够长的时间来检测系统的长期稳定性
- 配置修改可能导致周期性性能抖动或周期性的慢查询等问题，这些都很难察觉

## 特定场景下的基准测试价值

有时我们运行某些组合的基准测试，来仔细验证或压测服务器的某些特定部分，使得我们可以更好地理解这些行为。例如：

- 我们使用了多年的基准测试来理解InnoDB的刷新行为，寻找更好的刷新算法，以适应多种工作负载和硬件类型
- 我们经常测试各种设置，来理解它们的影响以及如何优化它们

但这不是一件简单的事情：
- 可能会花费很多天甚至很多个星期
- 对大部分人来说没有收益，因为服务器特定部分的认识局限往往会掩盖其他问题
- 有时特定的设置项组合在特定的边缘场景可能有更好的性能，但在实际生产环境这些配置项并不真的合适
  - 例如，可能会浪费大量内存
  - 或者优化了吞吐量却忽略了崩溃恢复的影响

## 如果必须进行基准测试的建议

如果必须这样做，我们建议：

1. **开发定制的基准测试包**：在开始配置服务器之前，开发一个包含所有可能工作负载的测试包，甚至包含一些边缘场景（如复杂查询）
2. **使用真实数据**：在实际数据上重放工作负载通常是一个好办法
3. **针对性优化**：如果已经定位到特定问题点（如某个查询运行很慢），可以尝试专门优化，但要注意可能对其他查询的负面影响
4. **渐进式变更**：
   - 一次改变一个或两个变量
   - 每次只调整一点点
   - 每次更改后运行基准测试
   - 确保运行足够长的时间来确认性能是否稳定

## 变更的意外结果

调整配置时可能会遇到意外结果：
- 把一个变量调大一点，观察到性能提升
- 再调大一点，却发现性能大幅下降

这可能是因为：
- 某些资源用得太多，如为缓冲区分配太多内存、频繁地申请和释放内存
- MySQL和操作系统或硬件之间的不匹配
- 参数间的相互影响，例如：
  - `sort_buffer_size`的最佳值可能会被CPU缓存的工作方式影响
  - `read_buffer_size`需要与服务器的预读和I/O子系统的配置相匹配

> **重要提示**：更大并不总是更好，有时反而更糟糕。一些变量也依赖于其他因素，这需要通过经验和对系统架构的理解来学习。

## 适合进行基准测试的场景

对于前面提到不建议大多数人执行基准测试的情况也有例外。我们有时会建议人们进行一些迭代基准测试，尽管通常与"服务器调优"有不同的内容：

### 1. 硬件容量规划
如果有一笔大的投资，如购买大量新的服务器，可以运行基准测试以了解硬件需求：
- 对不同大小的InnoDB缓冲池进行基准测试
- 制定"内存曲线"，展示真正需要多少内存
- 分析不同内存容量如何影响存储系统的要求

### 2. 高可用性规划
如果想了解InnoDB从崩溃中恢复需要多久时间：
- 反复设置一个备库
- 故意让它崩溃
- 测试InnoDB在重启中需要花费多久时间来做恢复

### 3. 工作负载比较
对于以读为主的应用程序：
- 在慢查询日志中捕捉所有查询（或用pt-query-digest分析TCP流量）
- 在服务器完全打开慢查询日志记录时，使用pt-log-player重放所有慢查询
- 用pt-query-digest分析输出报告
- 观察在不同硬件、软件和服务器设置下，查询语句运行的情况

**实例**：我们曾帮助客户评估迁移到内存更多但硬盘更慢的服务器上的性能变化。结果是大多数查询变得更快，但一些I/O密集型的分析查询反而变慢。