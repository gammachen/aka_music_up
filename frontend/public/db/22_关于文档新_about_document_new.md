# 数据库文档编写指南

## 目录
- [数据库文档编写指南](#数据库文档编写指南)
  - [目录](#目录)
  - [1. 文档的重要性](#1-文档的重要性)
  - [2. 数据库文档的关键组成部分](#2-数据库文档的关键组成部分)
    - [2.1 实体关系图（ER图）](#21-实体关系图er图)
    - [2.2 表、列以及视图](#22-表列以及视图)
    - [2.3 关系](#23-关系)
    - [2.4 触发器](#24-触发器)
    - [2.5 存储过程](#25-存储过程)
    - [2.6 SQL安全](#26-sql安全)
    - [2.7 数据库基础设施](#27-数据库基础设施)
    - [2.8 ORM](#28-orm)
  - [3. 结语](#3-结语)

## 1. 文档的重要性

世上没有能够代替文档的代码。尽管一个资深的开发人员能够通过仔细的分析以及凭借自己丰富的经验来解读一段代码，但依旧是非常消耗体力的。同时，代码也不能告诉你还有哪些问题没解决。

你应该将数据库的需求和实现也写成文档，就像对待程序代码那样。无论你是数据库的原始设计者，还是从别人那里接手的数据库，尽可能地使用下面的清单来检查文档的完整性。

## 2. 数据库文档的关键组成部分

### 2.1 实体关系图（ER图）

整份数据库文档中最重要的部分，就是一张描述了数据库中所有表及表之间关系的ER图。本书有几章中使用了简单的ER图。更复杂一点的ER图包含了列、主键、索引和其他数据库对象。

不少绘图软件包含了ER图的标记。还有些工具能够通过SQL脚本或者运行中的数据库直接通过反向工程得到ER图。

当数据库过于复杂，表特别多时，要在一张ER图中将所有条目都表示出来会有点不切实际。在这种情况下，你应该将其拆分到多张图中。通常你可以使用"子组"这个符号，这样一来，ER图中即包含了足够的阅读信息，也不至于让人看得晕头转向。

### 2.2 表、列以及视图

你仍需要为数据库编写文档，因为ER图不是描述每张表、列及其他对象的目的和使用方法的正确形式。

**表的文档化：**
- 需要描述一张表代表了哪种实体类型
- 对于查询表（如BugStatus）、交叉表（如BugsProducts）或依赖表（如Comments）等不易从表名理解的表，尤其需要详细说明
- 说明每张表预期存储多少行数据
- 说明如何对表进行查询
- 列出表中的索引

**列的文档化：**
- 说明列名和数据类型之外的含义
- 明确哪些值对于这一列是有意义的
- 说明列是否接受NULL值，以及原因
- 说明是否有唯一性约束，以及原因

**视图的文档化：**
- 说明创建视图的目的
- 指明哪些产品或用户需要使用该视图
- 说明视图是否提取表之间的复杂关系
- 说明视图是否允许无权限用户查询需要授权的表的部分数据
- 说明视图是否可以更新

### 2.3 关系

引用完整性约束表示了表和表之间的依赖关系，但可能并没有完整表达出你所设计的约束模型。例如：

- 分析像"Bugs.reported_by是非空的，但Bugs.assigned_to是可空的"这样的约束背后的业务逻辑
- 说明这是否意味着一个Bug可以在指派给任何人之前就被修复
- 如果不是，说明Bug的指派应该遵循什么规则

在某些情况下，可能存在一些隐式关系，但没有任何相关的约束。如果没有文档，别人很难知道存在这些关系。

### 2.4 触发器

数据验证、数据转换以及记录数据库变更，都是使用触发器的场景。你在触发器中实现了怎样的业务逻辑？这些都是需要记录在文档中的。

### 2.5 存储过程

要像API那样为存储过程编写文档：

- 说明存储过程要解决什么问题
- 说明存储过程是否会改变数据
- 说明输入输出参数的类型和意义
- 说明是否使用这个存储过程来替换一种查询请求，以解决某个性能瓶颈
- 说明使用这个存储过程是否会让没有权限的用户访问到需要权限的表

### 2.6 SQL安全

安全相关的文档应包括：

- 为应用程序指定了哪个数据库用户账号
- 每个用户都有哪些访问权限
- 提供了哪些SQL任务，哪些用户可以使用这些任务
- 是否有些用户是为了特殊的任务所定义的（如备份或报表）
- 使用哪种系统安全级别规定（如客户端必须通过SSL和RDBMS服务器端链接）
- 使用何种机制检测和屏蔽非法的认证请求（如暴力破解密码）
- 是否针对SQL注入做过一次完整的代码审查

### 2.7 数据库基础设施

这些信息对运维和DBA的同事来说是最重要的，但开发人员最好也对此有些了解：

- 使用哪个厂商的哪个版本的RDBMS服务
- 数据库服务器的主机名
- 是否使用了多台数据库服务器、冗余备份、服务器集群、访问代理等
- 网络结构
- 数据库服务器使用的端口
- 客户端程序连接时的特殊选项
- 数据库的用户密码
- 数据库的备份方案

### 2.8 ORM

你的项目可能将一部分应由数据库处理的逻辑写在了程序代码中，作为基于ORM类的层的一部分。文档应说明：

- 哪些业务逻辑是以这样的方式实现的
- 是数据验证、数据转换、日志、缓存还是配置

## 3. 结语

开发人员不喜欢维护工程文档。它们既难以编写，也很难保持实时更新，而且当你写了很多却少有人读的时候，会感到很失落。但即使是经验丰富或者极限编程的程序员也知道，他们可以不为程序的其他部分写文档，但一定要编写数据库部分的文档。